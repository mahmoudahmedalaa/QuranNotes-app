# AGENTS.md — QuranNotes

> This file is auto-discovered by AI agents. It bootstraps the project workflow.

## Instructions for AI Agent

**Before doing anything else, read these files in order:**

1. `.agent/rules/CODE_QUALITY.md` — Code standards, naming, testing
2. `.agent/rules/SECURITY.md` — Secrets, auth pitfalls, production hardening
3. `.agent/rules/AUTONOMY.md` — What to do alone vs. ask the user
4. `.agent/LESSONS_LEARNED.md` — Mistakes to avoid (updated after every session)
5. `.agent/workflows/TROUBLESHOOTING.md` — Known issues and fixes

**Reference as needed:**
- `.agent/workflows/XCODE_GUIDE.md` — Building, archiving, TestFlight
- `.agent/workflows/PRODUCTION_HARDENING.md` — Pre-release checklist
- `.agent/workflows/APP_STORE.md` — Full submission guide

---

## Project Overview

| Field | Value |
|:------|:------|
| **App** | QuranNotes |
| **Goal** | Mobile app for Quran study with note-taking, audio playback, and voice recording |
| **Stack** | React Native + Expo, Firebase (Compat), RevenueCat, react-native-track-player |
| **Platform** | iOS (primary), Android (future) |
| **Current Phase** | Post-Launch — Feature Development & Polish |
| **Last Updated** | February 14, 2026 |

---

## Architecture

```
QuranApp/
├── AGENTS.md                    ← This file
├── .agent/                      ← Agent config
│   ├── rules/                   ← Code quality, security, autonomy
│   ├── workflows/               ← Dev workflows, troubleshooting, checklists
│   ├── skills/                  ← Reusable AI skills
│   └── LESSONS_LEARNED.md       ← Mistakes to avoid
├── app/                         ← Expo Router screens (file-based routing)
├── src/                         ← App source (Clean Architecture)
│   ├── domain/                  ← Entities, repos, use cases (pure TS, zero deps)
│   ├── data/                    ← Data sources (local, remote, mappers)
│   ├── infrastructure/          ← External services
│   │   ├── audio/               ← AudioPlayerService (RNTP), AudioContext, PlaybackService
│   │   ├── auth/                ← Firebase Auth, ProContext
│   │   ├── firebase/            ← Firebase config (Compat layer)
│   │   ├── payments/            ← RevenueCat
│   │   └── settings/            ← SettingsContext
│   ├── presentation/            ← Components, hooks, theme
│   │   ├── components/          ← Grouped by feature (audio/, khatma/, quran/, etc.)
│   │   ├── hooks/               ← useQuran, useAudioRecorder, etc.
│   │   └── theme/               ← DesignSystem.ts (Colors, Spacing, etc.)
│   └── __tests__/               ← Integration tests
├── assets/                      ← App icons, splash screen
├── ios/                         ← Native iOS project (generated by prebuild)
├── docs/                        ← Reference docs (PRD, tech design)
├── index.js                     ← Custom entry point (RNTP registration)
├── app.json                     ← Expo config
└── package.json                 ← Dependencies
```

**Layer Rules:**
- `domain/` → Pure TypeScript, zero framework dependencies
- `data/` → Implements repository interfaces from domain
- `presentation/` → Thin UI, consumes hooks and contexts
- `infrastructure/` → External services only (Firebase, RNTP, RevenueCat)
- Dependencies point inward: presentation → infrastructure → domain

---

## Key Technical Decisions

| Decision | What | Why |
|:---------|:-----|:----|
| **Firebase Compat** | `firebase/compat/app` instead of modular SDK | Modular SDK causes "Component not registered" in RN |
| **RNTP for audio** | `react-native-track-player` for verse playback | Lock screen controls, Dynamic Island, gapless playback |
| **expo-av for recording** | `expo-av` retained only for voice recording | RNTP doesn't handle recording |
| **Local Xcode builds** | No EAS Build, no cloud services | Faster iteration, no cost, full control |
| **Custom entry point** | `index.js` registers RNTP before expo-router | Required for background audio service |

---

## Current Features

| Feature | Status | Key Files |
|:--------|:-------|:----------|
| Quran Reading | ✅ Shipped | `app/surah/[id].tsx`, `useQuran` |
| Verse Audio (RNTP) | ✅ Shipped | `AudioPlayerService.ts`, `AudioContext.tsx`, `PlaybackService.ts` |
| Lock Screen Controls | ✅ Shipped | `PlaybackService.ts`, `index.js` |
| GlobalMiniPlayer | ✅ Shipped | `GlobalMiniPlayer.tsx` |
| Voice Recording | ✅ Shipped | `useAudioRecorder`, `AudioRecorderService.ts` |
| Notes | ✅ Shipped | Notes CRUD system |
| Khatma Tracker | ✅ Shipped | `khatma/` components |
| Folders | ✅ Shipped | Folder organization |
| Auth (Google + Apple) | ✅ Shipped | Firebase Auth |
| Premium/Paywall | ✅ Shipped | RevenueCat + PaywallScreen |
| Onboarding | ✅ Shipped | Multi-step with listen/record screens |
| Daily Reminders | ✅ Shipped | Prayer time notifications |

---

## Workflow

### Plan → Execute → Verify

1. **Plan**: Understand the request, propose approach, get approval
2. **Execute**: Implement in small chunks, one feature at a time
3. **Verify**: `tsc --noEmit` + `npm test` + test on device

### Build Loop
```
Implement → tsc --noEmit → Pass? → Commit
                         → Fail? → Fix → Verify again
                         → 3 fails? → Stop, ask user
```

### Before Every Commit
```bash
npx tsc --noEmit                   # Type safety
npm test -- --passWithNoTests      # Tests pass
```

### Before Every Release
Follow `.agent/workflows/PRODUCTION_HARDENING.md` checklist.

---

## Key Rules

- **Never guess** — if a spec is ambiguous, ask the user
- **Small steps** — implement, verify, commit, repeat
- **`tsc --noEmit` always** — catches the bugs you can't see
- **Test on real device** — simulator misses native module issues
- **No EAS Build** — always build locally with Xcode
- **Learn from mistakes** — check `.agent/LESSONS_LEARNED.md`
- **Self-anneal** — after each milestone, update docs to match reality